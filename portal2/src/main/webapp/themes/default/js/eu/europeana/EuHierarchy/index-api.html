<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Hierarchy</title>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
		
</head>
<body>

	<script type="text/javascript">
		$(document).ready(function(){
			
			var data = {"data":[]};
			var max  = 10;
			var wrapTitle = function(title){
				return  {
			            "def": [ title ]
				}
			}
			
			/*
			BOOKS
				VOLUMES
					CHAPTERS
						VERSES
			*/			

			for(var i=0; i<4; i++){
				
				data.data[data.data.length] = { "id" : i, "index":i, "title" : wrapTitle("Book " + i), "type" : "text", "data" : [] };
					
				for(var j=0; j<4; j++){

					var book = data.data[data.data.length-1];
					book.data[book.data.length] = { "id" : i+"-"+j, "index":j, "title" : wrapTitle("Volume " + j + ' (b' + i + ')'), "type" : "text", "data" : [] };
					
					for(var k=0; k<4; k++){
						
						var volume = book.data[book.data.length-1];
						volume.data[volume.data.length] = { "id" : i+"-"+j+"-"+k, "index":k, "title" : wrapTitle("Chapter " + k + ' (b' + i + ', v' + j + ')'), "type" : "text", "data" : [] };

						for(var l=0; l<4; l++){
							
							var chapter = volume.data[volume.data.length-1];
							chapter.data[chapter.data.length] = { "id" : i+"-"+j+"-"+k+"-"+l, "index": l,  "title" : wrapTitle("Verse " + l + ' (b' + i + ', v' + j + ', c' + k + ')'), "type" : "text" };

						}
					}
				}
			}
			
			// utility for result write
			var parentData = function(path, limit){
				return {
			        "id": path.slice(0, path.length-1).join('-'),
			        "title": search(path.slice(0, path.length-1).join('-'), 'self.json', limit).object.title,
			        "type": "TEXT",
			        "index": path[path.length-2],
			        "hasChildren": true
				}
			}

			// utility for result write
			var coreData = function(data){
				return {
					"id" :			data.id,
					"title" :		data.title,
		            "type":			data.type,
		            "index":		data.index,
		            "hasChildren":	typeof data.data==='object'					
				}
			}
			
			// search
			var search = function(id, action, limit){
				
				console.log('search on id: ' + id + ' with action: ' + action + ' and limit: ' + limit + ' typeof ' + typeof limit);
				
				var res   = { "action" : action };
				var path  = id.split('-');
				var sData = JSON.parse(JSON.stringify(data));
			
				for(var i=0; i<path.length; i++){
					sData = sData.data[parseInt(path[i])];
				}

				/*
					SELF
				*/
				if(action==="self.json"){
					res.object    =  coreData(sData);
					res.hasParent = path.length>1;

					if(res.hasParent){
						res.parent = parentData(path, limit);
					}
					if(res.object.hasChildren){
						res.childrenCount = sData.data.length;
					}
				}
				
				/*
					CHILDREN
				*/

				else if(action==="children.json"){
					res.children = [];
					for(var i=0; i< Math.min(limit, sData.data.length); i++){
						res.children.push(coreData(sData.data[i]))
					}
					res.hasParent = path.length>1;
					res.childrenCount = sData.data.length;
				}
				
				/*
					FOLLOWING
				*/

				else if(action==="following-siblings.json"){
					
					res.parent = parentData(path, limit);
					res['following-siblings'] = [];
					
					var parentPath		= path.slice(0, path.length-1).join('-');
					var parentChildren	= search(path.slice(0, path.length-1).join('-'), 'children.json', max);					
					var start			= false;
					var added			= 0;
					
					for(var i=0; i<parentChildren.children.length; i++){
						if(start){
							res['following-siblings'].push(coreData(parentChildren.children[i]));
							added ++;
							if(added==limit){
								break;
							}
						}
						if(!start && parentChildren.children[i].id == id){
							start = true;
						}
					}
					res.hasParent = path.length>1;
					if(sData.data){
						res.childrenCount = sData.data.length;					
					}
				}
				
				/*
					PRECEDING
				*/

				else if(action==="preceeding-siblings.json"){

					res.parent = parentData(path, limit);
					res['preceeding-siblings'] = [];
					
					var parentChildren	= search(path.slice(0, path.length-1).join('-'), 'children.json', max);
					var start 			= false;
					var added			= 0;
					
					for(var i=parentChildren.children.length-1; i>=0; i--){
						
						if(start){
							res['preceeding-siblings'].push(coreData(parentChildren.children[i]));
							added ++;
							if(added==limit){
								break;
							}
						}
						if(!start && parentChildren.children[i].id == id){
							start = true;
						}
					}
					res.hasParent = path.length>1;
					if(sData.data){
						res.childrenCount = sData.data.length;					
					}
					
					/*
					res.parent = parentData(path, limit);
					res['preceeding-siblings'] = [];
					
					var parentChildren	= search(path.slice(0, path.length-1).join('-'), 'children.json', max);
					var start 			= true;
					var added			= 0;
					
					for(var i=0; i<parentChildren.children.length; i++){
						
						if(start && parentChildren.children[i].id == id){
							start = false;
						}
						if(start){
							res['preceeding-siblings'].push(coreData(parentChildren.children[i]));
							added ++;
							if(added==limit){
								break;
							}
						}
					}
					res.hasParent = path.length>1;
					if(sData.data){
						res.childrenCount = sData.data.length;					
					}
					*/
				}
				return res;
			}
			
			// UI BINDING
			
			$('#submit').click(function(){

				var id     = $('#id').val();
				var limit  = $('#limit').val();
				
				if(!id.length){
					$('#id').css('border', '1px solid red');
					return;
				}
				$('#id').css('border', '1px solid #999');
				
				if(limit.length){
					limit = parseInt(limit);
				}
				else{
					limit = max;	
				}
				var act = $("input[type='radio'][name='action']:checked").val();
				var res = search(id, act, limit);
				
				if(res['preceeding-siblings']){
					res['preceeding-siblings'] = res['preceeding-siblings'].reverse();
				}

				$('#result').html('<pre>' + JSON.stringify(res, undefined, 2) + '</pre>');
				
			});

			$('#id').add('#limit').on('keypress', function(e) {				
			    if (e.which == 13) {
			        e.preventDefault();
			        $('#submit').click();
			    }
			});
						
			$("input[type='radio']").click(function(){
				var act = $("input[type='radio'][name='action']:checked").val();
				if(act==="self.json"){
					$('#limit').hide();
				}
				else{
					$('#limit').show();					
				}
			})

			$('#id').focus();
		});
	</script>
	
	<input type="text"   id="id" value="1-1-3"/>
	<input type="button" id="submit" value="go"/>
	<input type="text"   id="limit"  placeholder="limit..." style="display:none; width:5em;"/>
	
	<br/>
	<input type="radio" id="r1" name="action" value="self.json" checked="checked"><label for="r1">self</label>
	<br>
	<input type="radio" id="r2" name="action" value="children.json"><label for="r2">children</label>
	<br>
	<input type="radio" id="r3" name="action" value="following-siblings.json"><label for="r3">following</label>
	<br>
	<input type="radio" id="r4" name="action" value="preceeding-siblings.json"><label for="r4">preceding</label>

	<div id="result" style="display:block; width:100%; border:1px solid #000; margin-top:1em;"></div>	

</body>

</html>

